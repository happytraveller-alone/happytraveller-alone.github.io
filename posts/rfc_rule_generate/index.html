<!doctype html><html lang=zh-Hans x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>TLS变异报文生成 | 小谢同学的修行小屋</title>
<link rel=canonical href=https://happytraveller-alone.github.io/posts/rfc_rule_generate/><meta name=author content="YuanFeng Xie"><meta name=description content="本文针对RFC规则抽取的过程进行详细说明，包括自然语言描述人工切分，手动划定转换节点，规则抽取工程，规则违反构建。本文以RFC8446文档举例说明，方法流程可以应用到其它具有网络状态转换的开源网络协议，例如RSTP。LLM基于GPT-4o-mini加系统提示词进行设计。
"><meta name=keywords content="TLS"><meta name=generator content="Hugo 0.139.2"><meta property="og:url" content="https://happytraveller-alone.github.io/posts/rfc_rule_generate/"><meta property="og:site_name" content="小谢同学的修行小屋"><meta property="og:title" content="TLS变异报文生成"><meta property="og:description" content="本文针对RFC规则抽取的过程进行详细说明，包括自然语言描述人工切分，手动划定转换节点，规则抽取工程，规则违反构建。本文以RFC8446文档举例说明，方法流程可以应用到其它具有网络状态转换的开源网络协议，例如RSTP。LLM基于GPT-4o-mini加系统提示词进行设计。"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-29T13:56:56+08:00"><meta property="article:modified_time" content="2024-11-27T14:18:30+00:00"><meta property="article:tag" content="TLS"><meta name=twitter:card content="summary"><meta name=twitter:title content="TLS变异报文生成"><meta name=twitter:description content="本文针对RFC规则抽取的过程进行详细说明，包括自然语言描述人工切分，手动划定转换节点，规则抽取工程，规则违反构建。本文以RFC8446文档举例说明，方法流程可以应用到其它具有网络状态转换的开源网络协议，例如RSTP。LLM基于GPT-4o-mini加系统提示词进行设计。"><link rel=stylesheet href=/css/output.min.css><link rel=stylesheet href=/css/code-wrap.css><link rel=stylesheet href=/css/syntax.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js></script></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav class="mt-4 lg:mt-8 py-4"><div class="container flex justify-between max-w-[65ch] mx-auto px-4 md:px-0"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:online" @click="flip = !flip" title=翻转一下！><div class="h-10 rounded-full"><img src=/images/logo.png alt=小谢同学的修行小屋></div></div><div><a href=https://happytraveller-alone.github.io/ class="text-lg font-semibold cursor-pointer">小谢同学的修行小屋</a><div class="text-base-content/60 text-sm">无人扶我青云志，我自踏雪至山巅</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul class="dropdown-content menu w-36 bg-base-100 rounded-box z-[1] shadow-md"><li><div role=link tabindex=0 class="inline-flex items-center p-2 cursor-pointer" @click="flip = !flip" title=关于我><ion-icon name=information-circle></ion-icon>关于我</div></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=归档><ion-icon name=archive></ion-icon>归档</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=所有分类><ion-icon name=grid></ion-icon>所有分类</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=所有标签><ion-icon name=pricetags></ion-icon>所有标签</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><div role=link tabindex=0 class="text-sm font-semibold cursor-pointer hover:underline" @click="flip = !flip" title=关于我>关于我</div><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/posts title=归档><ion-icon class=group-hover:text-primary-content name=archive></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/categories title=所有分类><ion-icon class=group-hover:text-primary-content name=grid></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/tags title=所有标签><ion-icon class=group-hover:text-primary-content name=pricetags></ion-icon></a></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="mt-4 px-4"><div><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="TLS变异报文生成"><meta itemprop=description content="本文针对RFC规则抽取的过程进行详细说明，包括自然语言描述人工切分，手动划定转换节点，规则抽取工程，规则违反构建。本文以RFC8446文档举例说明，方法流程可以应用到其它具有网络状态转换的开源网络协议，例如RSTP。LLM基于GPT-4o-mini加系统提示词进行设计。"><meta itemprop=datePublished content="2024-09-29T13:56:56+08:00"><meta itemprop=dateModified content="2024-11-27T14:18:30+00:00"><meta itemprop=wordCount content="4494"><meta itemprop=keywords content="TLS"><header><h1 itemprop=headline>TLS变异报文生成</h1><p class=text-sm>星期五, 10月 18, 2024
| <span>9分钟阅读</span>
| <span>更新于
星期三, 11月 27, 2024</span></p><div class="flex justify-between"><div class="flex items-center"><div class="avatar mr-1"><div class="w-8 rounded-full"><img class=my-0 src=/images/logo.jfif alt="YuanFeng Xie"></div></div><span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>YuanFeng Xie</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=TLS%e5%8f%98%e5%bc%82%e6%8a%a5%e6%96%87%e7%94%9f%e6%88%90&amp;url=https://happytraveller-alone.github.io/posts/rfc_rule_generate/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://happytraveller-alone.github.io/posts/rfc_rule_generate/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://wa.me/?text=TLS%e5%8f%98%e5%bc%82%e6%8a%a5%e6%96%87%e7%94%9f%e6%88%90%20https://happytraveller-alone.github.io/posts/rfc_rule_generate/" target=_blank rel="noopener noreferrer" title="Share on WhatsApp"><ion-icon class=group-hover:text-primary-content name=logo-whatsapp></ion-icon></a></div></div></header><p>本文针对RFC规则抽取的过程进行详细说明，包括自然语言描述人工切分，手动划定转换节点，规则抽取工程，规则违反构建。本文以RFC8446文档举例说明，方法流程可以应用到其它具有网络状态转换的开源网络协议，例如RSTP。LLM基于GPT-4o-mini加系统提示词进行设计。</p><h2 id=历史工作>历史工作</h2><p><img src=svg/simple/aflnet_simple.svg alt></p><blockquote class="dream-alert note"><p class=heading><ion-icon name=information-circle-outline></ion-icon>AFLnet</p><p>AFLnet搜集历史报文数据，构建状态机并利用状态机构建符合网络协议规范的报文序列，利用状态机选择器选取特定的报文序列，输入到待测服务端查看反馈。<strong>状态机的使用体现在输入报文序列的有效性上。</strong></p></blockquote><p><img src=image/hdiff_parse.png alt></p><blockquote class="dream-alert note"><p class=heading><ion-icon name=information-circle-outline></ion-icon>HDiff</p><p>以RFC规则作为输入，分别进行了<strong>报文结构和报文约束的抽取</strong>。报文结构用<strong>人工定义的ABNF文法进行文本解析获取</strong>，用于<strong>生成基础的合法报文</strong>；报文约束利用<strong>NLP方法捕获RFC中强情感约束的语句</strong>获取，用于<strong>指导变异报文</strong>。在规则抽取的过程中，可以获取到包含规则字段约束和规则处理约束的规范要求（SR）。</p></blockquote><blockquote class="dream-alert important"><p class=heading><ion-icon name=sparkles-outline></ion-icon>语法约束</p><p>语法约束：报文字段的长度，类型，部分报文字段的计算方式，顺序，依赖关系等<strong>影响报文解析，违反约束会导致解析错误</strong>；</p></blockquote><blockquote class="dream-alert important"><p class=heading><ion-icon name=sparkles-outline></ion-icon>语义约束</p><p>语义约束：部分报文字段的顺序，依赖关系，计算方式等<strong>影响报文的返回类型，但不影响报文解析，违反约束会导致错误反馈</strong>。</p></blockquote><p><img src=image/chatafl.png alt></p><blockquote class="dream-alert note"><p class=heading><ion-icon name=information-circle-outline></ion-icon>CHATAFL</p><p>在HDiff的基础上，利用LLM的提示词工程，将适用协议进行推广，不再局限于HTTP，融合了AFLnet的思想，加入状态机，利用LLM进行消息骨架生成和消息变异。</p></blockquote><p><img src=svg/simple/rfcdiff_flow.svg alt>
<img src=image/rfcdiff_tls.png alt></p><blockquote class="dream-alert note"><p class=heading><ion-icon name=information-circle-outline></ion-icon>RFCdiff</p><p>RFCdiff相比CHATAFL，专注于TLS，TLS协议难度更加复杂。难点在于TLS握手报文内部各个字段的语法约束多，在进行语义约束违法变异报文时，会打破语法约束，造成解析错误。</p></blockquote><h2 id=流程概述>流程概述</h2><blockquote class="dream-alert note"><p class=heading><ion-icon name=information-circle-outline></ion-icon>目标</p><p>选取RFC文本描述规则作为输入，利用LLM作为工具载体，构建Agent链，抽取客户端发送消息的构建约束，以及服务端接收消息的处理反馈，用以指导模糊测试，检查RFC标准文档与网路协议代码实现之间的不一致。</p></blockquote><p>TLS异常握手报文的生成可以划分为四个阶段：规则处理，种子收集，变异算子生成，测试验证。<strong>状态机的使用体现在输入报文的变异策略上。</strong></p><ul><li>规则抽取<ul><li>结构：利用LLM进行规则提取，依次进行文档分割，规则抽取，规则组合构建，规则筛选</li><li>阶段成果：<ul><li>文档分割：216个语义文段-> 97个包含强语气要求规则约束的文段</li><li>规则抽取+规则组合构建：174个约束规则->55个明确包含消息发送约束和消息处理约束的规则</li><li>规则筛选：ClientHello报文且无关消息序列依赖的规则20条，<div class=highlight><pre tabindex=0 style=color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-markdown data-lang=markdown><span style=display:flex><span>期望的：&lt;<span style=color:#c6a0f6>CLI-MSG-CONST</span>&gt; &lt;<span style=color:#c6a0f6>1</span>&gt; (Clients MUST place the &#34;pre_shared_key&#34; extension as the last extension in the ClientHello) + &lt;<span style=color:#c6a0f6>SRV-MSG-PROC</span>&gt; &lt;<span style=color:#c6a0f6>1</span>&gt; (Servers MUST verify that the &#34;pre_shared_key&#34; extension is the last extension in ClientHello and fail the handshake with an &#34;illegal_parameter&#34; alert if it is not)
</span></span><span style=display:flex><span>实际的：&lt;<span style=color:#c6a0f6>CLI-MSG-CONST</span>&gt; &lt;<span style=color:#c6a0f6>1</span>&gt; (Clients MUST update the &#34;pre_shared_key&#34; extension by recalculating the &#34;obfuscated_ticket_age&#34; and binder values, and MAY remove incompatible PSKs) + &lt;<span style=color:#c6a0f6>SRV-MSG-PROC</span>&gt; &lt;<span style=color:#c6a0f6>0</span>&gt; (Servers MUST verify the updated &#34;pre_shared_key&#34; values in the new ClientHello)</span></span></code></pre></div></li></ul></li></ul></li></ul><ul><li>种子收集负责将收集到的TLS历史握手报文改造成变异模板</li><li>变异算子生成包括，规则违反生成，变异算子序列生成，状态转换生成</li><li>测试验证根据规则抽取得到的变异算子序列，消息模板，进行变异报文内容填充，输入到待测服务器查看反馈，并与状态转换进行比较，如果一致则跳过，如果不一致则列为问题报文进行分析</li></ul><h2 id=规则抽取>规则抽取</h2><figure style="text-align:center;margin:-5px 0"><div style=display:flex;justify-content:center;align-items:center><img src=svg/detailed/rfcdiff_collection.svg alt=规则抽取流程图 style=width:450px;max-width:100%;height:auto></div></figure><blockquote class="dream-alert important"><p class=heading><ion-icon name=sparkles-outline></ion-icon>规则抽取流程概览</p><p>规则抽取划分为三部分：</p><ul><li><strong>完整语义文段抽取(Natural Semantics-based Splitting)</strong>：选取RFC8446文档的握手协议章节作为输入，利用LLM的文本总结能力，基于文档主题以及文段内容完整度对文段进行分割，输出文段片段内容以及对应主题。</li><li><strong>文段抽取形式化规则(NL Rule Extraction)</strong>：选取分割后的片段，利用LLM的文本分类能力，基于文档内容进行进一步划分分类，将文档内容转换为消息构造约束(MSG-CONST)，消息处理约束(MSG-PROC)，再根据TLS协议的特性，具有两种类型的终端：客户端和服务端。进行进一步划分，可以分为<strong>客户端消息构造约束(SRV-MSG-PROC)，客户端消息处理约束(CLI-MSG-PROC)，服务端消息构造约束(SRV-MSG-CONST)，服务端消息处理约束(SRV-MSG-PROC)</strong>。同时，添加约束强度及原始文本两个属性，约束强度可以反应规则描述的强制执行程度（MUST, MAY等）以及约束获取的支撑性（约束是直接从描述中获得还是从文本描述中推理得到）；原始文本有助于利用LLM生成结果进行人工检查校验，查看LLM的设计缺陷，进行后续改进。</li><li><strong>形式化规则配对(Rule Pair And Filter)</strong>：分类后的形式化规则信息零散，不能有效指导TLS协议实现的测试，需要对形式化规则进行配对，构成规则对，每个规则对包含两个消息，消息的组合包含多种，但以下两种居多：<strong>客户端消息构造约束(SRV-MSG-PROC)+服务端消息处理约束(SRV-MSG-PROC)；客户端消息处理约束(CLI-MSG-PROC)+服务端消息处理约束(SRV-MSG-PROC)</strong>。对应到TLS握手过程，即服务端如何处理客户端发送的满足特定约束的握手报文，或是客户端如何处理服务端发送的满足特定约束的握手报文。当前实验专注于第一种情况，<strong>客户端消息构造约束(SRV-MSG-PROC)+服务端消息处理约束(SRV-MSG-PROC)</strong>，报文主体即为Clienthello，报文反馈有三种大类：ServerHello, ServerRetryRequest, Alert。</li></ul></blockquote><blockquote class="dream-alert tip"><p class=heading><ion-icon name=bulb-outline></ion-icon>提示</p><p>由于LLM输出会基于已有内容进行推测，输出内容可能与已有内容冲突，添加角色说明，任务描述，思维链设计，输出约束，样例介绍等，辅助LLM更好完成任务</p></blockquote><ul><li>文档分割: 基于自然语言的完整语义进行抽取。<div class=highlight><pre tabindex=0 style=color:#cad3f5;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-markdown data-lang=markdown><span style=display:flex><span>When multiple extensions of different types are present, the extensions MAY appear in any order, with the exception of &#34;pre_shared_key&#34; which MUST be the last extension in the ClientHello (but can appear anywhere in the ServerHello extensions block). There MUST NOT be more than one extension of the same type in a given extension block.</span></span></code></pre></div></li><li>规则抽取与规则配对：只获取CMC+SMP模式<div class=highlight><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>示例输入
</span></span><span class=line><span class=cl>&#39;&#39;&#39;
</span></span><span class=line><span class=cl>When multiple extensions of different types are present, the extensions MAY appear in any order, with the exception of &#34;pre_shared_key&#34; which MUST be the last extension in the ClientHello (but can appear anywhere in the ServerHello extensions block). There MUST NOT be more than one extension of the same type in a given extension block.
</span></span><span class=line><span class=cl>&#39;&#39;&#39;
</span></span><span class=line><span class=cl>示例输出
</span></span><span class=line><span class=cl>&#39;&#39;&#39;
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>CLI-MSG-CONST</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>1</span><span class=p>&gt;</span> (Clients MUST place the &#34;pre_shared_key&#34; extension last in ClientHello, while other extensions MAY appear in any order) + <span class=p>&lt;</span><span class=nt>SRV-MSG-PROC</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>1</span><span class=p>&gt;</span> (Servers MUST verify that the &#34;pre_shared_key&#34; is the last extension in ClientHello)
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>CLI-MSG-CONST</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>1</span><span class=p>&gt;</span> (Clients MUST NOT include multiple extensions of the same type in any extension block) + <span class=p>&lt;</span><span class=nt>SRV-MSG-PROC</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>1</span><span class=p>&gt;</span> (Servers MUST reject ClientHello messages containing duplicate extension types)
</span></span><span class=line><span class=cl>&#39;&#39;&#39;</span></span></code></pre></div></li></ul><h2 id=模板构建>模板构建</h2><figure style="text-align:center;margin:-5px 0"><div style=display:flex;justify-content:center;align-items:center><img src=svg/detailed/rfcdiff_seed.svg alt=报文模板生成流程图 style=width:450px;max-width:100%;height:auto></div></figure><blockquote class="dream-alert important"><p class=heading><ion-icon name=sparkles-outline></ion-icon>报文模板构建流程概览</p><p>报文模板构建划分为两部分：</p><ul><li><strong>握手报文模板构建(TLS Handshake Packet Template Generation)</strong>：利用TLS框架（rustls）构建握手模板报文。当前实验关注ClientHello报文</li><li><strong>报文模板解析(TLS Handshake Packet Field Parsing)</strong>：选取握手模板报文，遍历报文内容，构建解析字段框架，针对字段进行固定值/固定范围/随机值等类型的设计。当前实验关注ClientHello报文的字段解析。</li></ul></blockquote><ul><li>握手报文模板生成<div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=nb>Box</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>std</span>::<span class=n>error</span>::<span class=n>Error</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 网络环境测试
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>perform_local_network_test</span><span class=p>()</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 运行指令参数获取
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>matches</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_command_matches</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 运行说明
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>matches</span><span class=p>.</span><span class=n>get_flag</span><span class=p>(</span><span class=s>&#34;use_guide&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>terminal</span>::<span class=n>print_help</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>Ok</span><span class=p>(());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 参数校验
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>server_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_server_name</span><span class=p>(</span><span class=o>&amp;</span><span class=n>matches</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>server_ip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_server_ip</span><span class=p>(</span><span class=o>&amp;</span><span class=n>matches</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_port</span><span class=p>(</span><span class=o>&amp;</span><span class=n>matches</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>easy_read</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>matches</span><span class=p>.</span><span class=n>get_flag</span><span class=p>(</span><span class=s>&#34;easy_read&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>print_configuration_info</span><span class=p>(</span><span class=o>&amp;</span><span class=n>server_name</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>server_ip</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=n>easy_read</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 服务器环境测试
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>perform_server_environment_test</span><span class=p>(</span><span class=o>&amp;</span><span class=n>server_ip</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// TLS握手准备，TCP连接建立
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arc</span>::<span class=n>new</span><span class=p>(</span><span class=n>network_connect</span>::<span class=n>create_tls_config</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>network_connect</span>::<span class=n>create_client_connection</span><span class=p>(</span><span class=n>config</span><span class=p>,</span><span class=w> </span><span class=n>server_name</span><span class=p>.</span><span class=n>clone</span><span class=p>())</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// clienthello报文模板初始化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>client_hello</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Vec</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 模板报文生成
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>conn</span><span class=p>.</span><span class=n>write_tls</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>client_hello</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 解析clienthello报文
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>parse_client_hello_if_enabled</span><span class=p>(</span><span class=o>&amp;</span><span class=n>matches</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>client_hello</span><span class=p>,</span><span class=w> </span><span class=n>easy_read</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>send_client_hello_if_test_env</span><span class=p>(</span><span class=o>&amp;</span><span class=n>matches</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>server_ip</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>conn</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>client_hello</span><span class=p>,</span><span class=w> </span><span class=n>easy_read</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>terminal</span>::<span class=n>print_help</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></li><li>报文模板解析：<div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>ClientHello</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// TLS Record Layer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>content_type</span>: <span class=kt>u8</span><span class=p>,</span><span class=w>           </span><span class=c1>// 固定值 0x16
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>version</span>: <span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>2</span><span class=p>],</span><span class=w>           </span><span class=c1>// 固定值 [0x03, 0x01]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>record_length</span>: <span class=kt>u16</span><span class=p>,</span><span class=w>         </span><span class=c1>// 动态值，需要计算
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Handshake Layer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>handshake_type</span>: <span class=kt>u8</span><span class=p>,</span><span class=w>         </span><span class=c1>// 固定值 0x01
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>handshake_length</span>: <span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>3</span><span class=p>],</span><span class=w>  </span><span class=c1>// 动态值，需要计算
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ClientHello specific fields
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>client_version</span>: <span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>2</span><span class=p>],</span><span class=w>    </span><span class=c1>// 固定值 [0x03, 0x03]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>random</span>: <span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>32</span><span class=p>],</span><span class=w>           </span><span class=c1>// 32 字节随机数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>session_id_length</span>: <span class=kt>u8</span><span class=p>,</span><span class=w>      </span><span class=c1>// 动态值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>session_id</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>,</span><span class=w>        </span><span class=c1>// 动态值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>cipher_suites_length</span>: <span class=kt>u16</span><span class=p>,</span><span class=w>  </span><span class=c1>// 动态值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>cipher_suites</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>,</span><span class=w>     </span><span class=c1>// 动态值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>compression_methods_length</span>: <span class=kt>u8</span><span class=p>,</span><span class=w>  </span><span class=c1>// 动态值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>compression_methods</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>,</span><span class=w>    </span><span class=c1>// 动态值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>extensions_length</span>: <span class=kt>u16</span><span class=p>,</span><span class=w>     </span><span class=c1>// 动态值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>extensions</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>Extension</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=c1>// 动态值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Extension</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>extension_type</span>: <span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>2</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>extension_length</span>: <span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>2</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>extension_content</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></li></ul><h2 id=变异算子生成>变异算子生成</h2><figure style="text-align:center;margin:-5px 0"><div style=display:flex;justify-content:center;align-items:center><img src=svg/detailed/rfcdiff_mutator.svg alt=变异算子生成流程图 style=width:950px;max-width:100%;height:auto></div></figure><blockquote class="dream-alert important"><p class=heading><ion-icon name=sparkles-outline></ion-icon>变异算子生成流程概览</p><p>变异算子生成划分为三部分：</p><ul><li><strong>规则违反描述配对(Structured Rule Violation Pair)</strong>：选取形式化规则配对中的客户端消息构建约束，更新为客户端消息构架约束违反，服务端消息处理约束保持不变。当前实验关注ClientHello报文构建约束违反的生成。</li><li><strong>规则违反反馈匹配(NL Rule Violation Pair Expected Response)</strong>：选取客户端约束已更新为消息违反的规则对，更新规则队中的服务端消息处理约束为服务端消息处理反馈。当前实验关注ClientHello报文会触发的服务端反馈。</li><li><strong>变异算子生成(Mutation Operator Sequence Generation)</strong>：利用原子级变异算子(Atomic Mutator)进行序列组合，构成变异算子序列，将规则对中的客户端约束违反更新为消息变异算子序列。当前实验关注ClientHello报文的变异算子序列。</li></ul></blockquote><ul><li>规则违反描述配对(Structured Rule Violation Pair)<div class=highlight><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl><span class=k>-</span> 示例输入
</span></span><span class=line><span class=cl>&#39;&#39;&#39;
</span></span><span class=line><span class=cl>{CMC} <span class=p>&lt;</span><span class=nt>1</span><span class=p>&gt;</span> (Clients MAY include multiple extensions in any order, except for &#34;pre_shared_key&#34; which MUST be the last extension.) + {SMP} <span class=p>&lt;</span><span class=nt>1</span><span class=p>&gt;</span> (Servers MAY process multiple extensions in any order, except for &#34;pre_shared_key&#34; which MUST be the last extension.)
</span></span><span class=line><span class=cl>&#39;&#39;&#39;
</span></span><span class=line><span class=cl><span class=k>-</span> 示例输出
</span></span><span class=line><span class=cl>&#39;&#39;&#39;
</span></span><span class=line><span class=cl>{CMC} (Send a &#34;pre_shared_key&#34; extension with an incorrect &#34;obfuscated_ticket_age&#34; value that does not match the expected computation.)  + {SMP} <span class=p>&lt;</span><span class=nt>1</span><span class=p>&gt;</span> (Servers MAY process multiple extensions in any order, except for &#34;pre_shared_key&#34; which MUST be the last extension.)
</span></span><span class=line><span class=cl>{CMC} (Include an additional &#34;pre_shared_key&#34; extension with conflicting binder values, causing ambiguity in the handshake.) + {SMP} <span class=p>&lt;</span><span class=nt>1</span><span class=p>&gt;</span> (Servers MAY process multiple extensions in any order, except for &#34;pre_shared_key&#34; which MUST be the last extension.)
</span></span><span class=line><span class=cl>&#39;&#39;&#39;</span></span></code></pre></div></li><li>规则违反反馈匹配(NL Rule Violation Pair Expected Response)<div class=highlight><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl><span class=k>-</span> 示例输入
</span></span><span class=line><span class=cl>&#39;&#39;&#39;
</span></span><span class=line><span class=cl>{CMC} (Send a &#34;pre_shared_key&#34; extension with an incorrect &#34;obfuscated_ticket_age&#34; value that does not match the expected computation.)  + {SMP} <span class=p>&lt;</span><span class=nt>1</span><span class=p>&gt;</span> (Servers MAY process multiple extensions in any order, except for &#34;pre_shared_key&#34; which MUST be the last extension.)
</span></span><span class=line><span class=cl>&#39;&#39;&#39;
</span></span><span class=line><span class=cl><span class=k>-</span> 示例输出
</span></span><span class=line><span class=cl>&#39;&#39;&#39;
</span></span><span class=line><span class=cl>{CMC} (Send a &#34;pre_shared_key&#34; extension with an incorrect &#34;obfuscated_ticket_age&#34; value that does not match the expected computation.)  + {SMP} (The server MUST abort the handshake with an &#34;illegal_parameter&#34; alert)
</span></span><span class=line><span class=cl>&#39;&#39;&#39;</span></span></code></pre></div></li><li>原子变异算子(Atomic Mutator)<div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// 根据HashMap的Key进行对应mutate函数的选取，value即为变异后的值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>mutate</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>mutation_config</span>: <span class=kp>&amp;</span><span class=nc>HashMap</span><span class=o>&lt;</span><span class=kt>u8</span><span class=p>,</span><span class=w> </span><span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=o>&amp;</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>mutation_config</span><span class=p>.</span><span class=n>iter</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mi>1</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>mutate_random</span><span class=p>(</span><span class=n>value</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mi>2</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>mutate_session_id</span><span class=p>(</span><span class=n>value</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mi>3</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>mutate_cipher_suites</span><span class=p>(</span><span class=n>value</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 4 =&gt; self.mutate_compression_methods(value),
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1>// 5 =&gt; self.mutate_extensions(value),
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Unknown mutation key: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 总的变异过程，
</span></span></span><span class=line><span class=cl><span class=c1>// 1. 利用解析后的clienthello进行初始化，
</span></span></span><span class=line><span class=cl><span class=c1>// 2. 利用mutate进行变异，
</span></span></span><span class=line><span class=cl><span class=c1>// 3. 增强语法正确性，更新所有长度数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>mutate_client_hello</span><span class=p>(</span><span class=n>client_hello</span>: <span class=kp>&amp;</span><span class=nc>ClientHello</span><span class=p>,</span><span class=w> </span><span class=n>mutation_config</span>: <span class=kp>&amp;</span><span class=nc>HashMap</span><span class=o>&lt;</span><span class=kt>u8</span><span class=p>,</span><span class=w> </span><span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>ClientHello</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>mutator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ClientHelloMutator</span>::<span class=n>new</span><span class=p>(</span><span class=n>client_hello</span><span class=p>.</span><span class=n>clone</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mutator</span><span class=p>.</span><span class=n>mutate</span><span class=p>(</span><span class=n>mutation_config</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mutator</span><span class=p>.</span><span class=n>update_lengths</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mutator</span><span class=p>.</span><span class=n>get_mutated_client_hello</span><span class=p>().</span><span class=n>clone</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></li><li>变异算子生成：待补充</li></ul><h2 id=环境验证>环境验证</h2><figure style="text-align:center;margin:-5px 0"><div style=display:flex;justify-content:center;align-items:center><img src=svg/detailed/rfcdiff_validation.svg alt=环境验证流程图 style=width:300px;max-width:100%;height:auto></div></figure><blockquote class="dream-alert important"><p class=heading><ion-icon name=sparkles-outline></ion-icon>环境验证流程概览</p><p><strong>环境验证</strong>：利用模板构建步骤获得的<strong>握手报文模板</strong>以及变异算子生成步骤生成的<strong>变异算子序列</strong>，<strong>服务端预期反馈</strong>三个内容作为<strong>输入</strong>，对握手报文模板使用变异算子序列，生成变异的握手报文并在测试环境中发送给服务器，获取服务器反馈并与服务器预期反馈进行比较，如果符合，则忽略，如果不符合，需要存储该异常报文以及对应的变异算子序列，用以指导下轮变异算子生成。</p></blockquote><blockquote class="dream-alert tip"><p class=heading><ion-icon name=bulb-outline></ion-icon>提示</p><p>测试环境搭建选取windows server 2022（老版本仅支持TLS1.2版本，不支持TLS1.3）作为测试客户机，在VMware上完成安装，基于IIS服务，构建自建证书，搭建TLS服务器</p></blockquote><h2 id=agent部署>Agent部署</h2><p>Agent部署采用FASTPOE-API接口进行实现，设计系统提示词，调整调用的LLM，temperature进行输出结果的调整。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>__future__</span> <span class=kn>import</span> <span class=n>annotations</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>AsyncIterable</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>fastapi_poe</span> <span class=k>as</span> <span class=nn>fp</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>modal</span> <span class=kn>import</span> <span class=n>App</span><span class=p>,</span> <span class=n>Image</span><span class=p>,</span> <span class=n>asgi_app</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=n>SYSTEM_PROMPT</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class="line hl"><span class=cl><span class=s2>prompt mentioned
</span></span></span><span class="line hl"><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PromptBot</span><span class=p>(</span><span class=n>fp</span><span class=o>.</span><span class=n>PoeBot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_response</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>:</span> <span class=n>fp</span><span class=o>.</span><span class=n>QueryRequest</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>AsyncIterable</span><span class=p>[</span><span class=n>fp</span><span class=o>.</span><span class=n>PartialResponse</span><span class=p>]:</span>
</span></span><span class="line hl"><span class=cl>        <span class=n>request</span><span class=o>.</span><span class=n>temperature</span> <span class=o>=</span> <span class=mf>0.7</span>
</span></span><span class=line><span class=cl>        <span class=n>request</span><span class=o>.</span><span class=n>query</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>fp</span><span class=o>.</span><span class=n>ProtocolMessage</span><span class=p>(</span><span class=n>role</span><span class=o>=</span><span class=s2>&#34;system&#34;</span><span class=p>,</span> <span class=n>content</span><span class=o>=</span><span class=n>SYSTEM_PROMPT</span><span class=p>,</span> <span class=n>content_type</span><span class=o>=</span><span class=s2>&#34;text/plain&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span> <span class=o>+</span> <span class=n>request</span><span class=o>.</span><span class=n>query</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>for</span> <span class=n>msg</span> <span class=ow>in</span> <span class=n>fp</span><span class=o>.</span><span class=n>stream_request</span><span class=p>(</span>
</span></span><span class="line hl"><span class=cl>            <span class=n>request</span><span class=p>,</span> <span class=s2>&#34;GPT-4o-Mini&#34;</span><span class=p>,</span> <span class=n>request</span><span class=o>.</span><span class=n>access_key</span>
</span></span><span class=line><span class=cl>        <span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>msg</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_settings</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>setting</span><span class=p>:</span> <span class=n>fp</span><span class=o>.</span><span class=n>SettingsRequest</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>fp</span><span class=o>.</span><span class=n>SettingsResponse</span><span class=p>:</span>
</span></span><span class="line hl"><span class=cl>        <span class=k>return</span> <span class=n>fp</span><span class=o>.</span><span class=n>SettingsResponse</span><span class=p>(</span><span class=n>server_bot_dependencies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;GPT-4o-Mini&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>REQUIREMENTS</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;fastapi-poe==0.0.48&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>image</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>debian_slim</span><span class=p>()</span><span class=o>.</span><span class=n>pip_install</span><span class=p>(</span><span class=o>*</span><span class=n>REQUIREMENTS</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>App</span><span class=p>(</span><span class=s2>&#34;prompt-bot-poe&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.function</span><span class=p>(</span><span class=n>image</span><span class=o>=</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@asgi_app</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fastapi_app</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>bot</span> <span class=o>=</span> <span class=n>PromptBot</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># see https://creator.poe.com/docs/quick-start#configuring-the-access-credentials</span>
</span></span><span class=line><span class=cl>    <span class=c1># app = fp.make_app(bot, access_key=&lt;YOUR_ACCESS_KEY&gt;, bot_name=&lt;YOUR_BOT_NAME&gt;)</span>
</span></span><span class="line hl"><span class=cl>    <span class=n>app</span> <span class=o>=</span> <span class=n>fp</span><span class=o>.</span><span class=n>make_app</span><span class=p>(</span><span class=n>bot</span><span class=p>,</span> <span class=n>access_key</span><span class=o>=</span><span class=s2>&#34;**************************&#34;</span><span class=p>,</span> <span class=n>bot_name</span><span class=o>=</span><span class=s2>&#34;********************&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>app</span></span></span></code></pre></div><blockquote class="dream-alert tip"><p class=heading><ion-icon name=bulb-outline></ion-icon>提示</p><p>bot_name以及access_key根据server_bot给出的内容进行修改，在modal serve阶段测试后，利用modal deploy进行部署，需要<strong>及时更新server bot内部的API</strong></p></blockquote><h2 id=存在问题>存在问题</h2><ul><li>限定条件的确认：TLS1.3版本的客户端，进行的变异是客户端发送报文内容（clienthello）的变异</li><li>agent的系统提示词设计需要改进</li><li>基于RFC规则的差分测试，将客户端报文规则违反和预期服务器反馈建立联系</li></ul><h2 id=参考资料>参考资料</h2><ul><li><a href=https://www.rfc-editor.org/info/rfc8446>RFC8446协议</a></li><li><a href=https://creator.poe.com/docs/quick-start>POE SERVER BOT 部署</a></li><li><a href=https://github.com/poe-platform/server-bot-quick-start>POE SERVER 仓库</a></li><li><a href=https://creator.poe.com/docs/fastapi_poe-python-reference>API参数说明</a></li><li><a href=https://zhuanlan.zhihu.com/p/677595969>批量调用POE-API</a></li><li><a href=https://github.com/snowby666/poe-api-wrapper>调用POE的python接口</a></li><li><a href=https://github.com/rustls/rustls>Rustls接口库</a></li><li><a href=https://docs.rs/rustls/latest/rustls/>Rustls接口文档</a></li></ul></article></div></div><footer class="flex justify-between items-center gap-2 max-w-[65ch] mx-auto px-4 md:px-0 py-12"><div><p>© 2024 小谢同学的修行小屋</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'moon', status: 'y' },
    { name: 'sunny', status: 'n' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center h-[32px] px-2 gap-2 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="max-w-[65ch] mt-8 mx-auto px-4"><div><div class="mb-4 text-lg font-medium">关于我</div><div class="prose dark:prose-invert"><p><figure><img src=/resume/profile2.png width=100></figure>一名喜欢RUST的菜鸟程序员</p><h4 id=教育背景研二在读>教育背景（研二在读）</h4><ul><li>2019.09 - 2023.06 天津大学 · 智能与计算学部 · 网络安全专业 · 全日制 · 本科</li><li>2023.09 - 2026.06 天津大学 · 智能与计算学部 · 电子信息专业 · 全日制 · 硕士研究生</li></ul></div></div><div class="divider divider-vertical"></div><div><div class="mb-4 text-lg font-medium">浏览器漏洞挖掘项目</div><div class="prose dark:prose-invert"><p><strong>V8引擎的模糊测试工具改进</strong></p><p>时间：2021.09-2022.04</p><p>内容：聚焦于优化JavaScript引擎的测试方法。研究团队基于SOAT改进部署了V8引擎测试环境，并通过分析测例覆盖率和已知CVE，优化了测试流程。</p><p>成果：成功捕获了一个谷歌引擎的<a href="https://bugs.chromium.org/p/v8/issues/detail?id=12563">逻辑漏洞</a>，获得了修复反馈</p><p><strong>JS引擎WASM模块漏洞挖掘研究</strong></p><p>时间：2023.11-2024.4</p><p>内容：阅读标准手动编写了WASM语法规则，调研了主流JS引擎的WASM支持情况，并基于V8构建了WASM二进制框架。</p><p>成果：<a href=https://github.com/happytraveller-alone/antlr_wat/tree/main/wat_grammar_check_java>语法规则</a>、调研报告和<a href=https://github.com/happytraveller-alone/antlr_wat/tree/main/wasm_domato>二进制构建框架</a>，成功捕获<a href="https://bugs.webkit.org/show_bug.cgi?id=271030">特性缺陷</a>并得到修复</p></div></div><div class="divider divider-vertical"></div><div><div class="mb-4 text-lg font-medium">数据库缺陷研究项目</div><div class="prose dark:prose-invert"><p><strong>关系型数据库缺陷的实证研究</strong></p><p>时间：2022.12-2023.11</p><p>内容：通过构建统一的数据库逻辑框架，系统收集并分析了大量数据库缺陷。对777个缺陷进行了深入分析，特别聚焦SQL数据类型问题，并据此改进了模糊测试方法。</p><p>成果：构建<a href=https://github.com/sqlttest/SQLT/blob/main/dataset.xlsx>缺陷数据集</a>, 开发<a href=https://github.com/sqlttest/SQLT>SQLT测试框架</a>。</p></div></div><div class="divider divider-vertical"></div><div><div class="mb-4 text-lg font-medium">网络协议漏洞挖掘项目</div><div class="prose dark:prose-invert"><p><strong>基于 RFC的 SSL/TLS模糊测试</strong></p><p>时间：2024.4 – today</p><p>内容：梳理TLS协议模糊测试的相关工作，关注基于状态机的网络协议模糊测试方法。复现历史漏洞，了解TLS报文结构，追溯相关漏洞代码。分析RFC文档，提取字段约束，构建状态转移范式，并据此完善了TLS协议的有限状态机模型。</p><p>成果：完成相关工作调研, 漏洞复现报告, <strong>状态范式数据集</strong></p></div></div><div class="divider divider-vertical"></div></div></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=/js/main.min.js></script><script type=module src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.esm.js></script><script nomodule src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.js></script><script defer src=/js/clipboard/clipboard.js></script><link rel=stylesheet href=/css/copy-paste.css></body></html>